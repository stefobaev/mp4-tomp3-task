import boto3
import os
import tempfile
import json
from moviepy.editor import VideoFileClip

....get env.... .echo $var
https://s3.amazonaws.com/bucket-for-nik-task-convertor-mp4-to-mp3/package/mypackage.zip


scp file user@ip:/home/ubuntu


s3 = boto3.client('s3')
sqs = boto3.client('sqs')
queue_url = "https://sqs.us-east-1.amazonaws.com/366915744137/MyQueue"

def lambda_handler(event,context):
    # Get s3 bucket and key of the uploaded video file
    bucket = event['Records'][0]['s3']['bucket']['name']
    key = event['Records'][0]['s3']['object']['key']
    
    # Define the input and output file path
    input_file = '/tmp/input.mp4'
    output_file = '/tmp/output.mp3'
    
    # Download the video file from s3 to a temporary location
    with open(input_file, 'wb') as f:
        s3.download_fileobj(bucket,key,f)
        
    # Convert the video file to an audio file using MoviePy
    clip = VideoFileClip(input_file)
    clip.audio.write_audiofile(output_file)
    
    # Upload the resulting audio file to s3
    processed_key = 'processed/'+output_file.strip('/tmp')
    s3.upload_file(output_file,bucket,processed_key)
    
    # Get the email address from the s3 object metadata
    response = s3.head_object(Bucket=bucket, Key=key)
    email = response['Metadata']['email']
    
    # Send the filename and email to the SQS queue
    message = {
        'filename': output_file.strip('/tmp/'),
        'email': email
    }
    
    response = sqs.send_message(
        QueueUrl=queue_url,
        MessageBody=json.dumps(message)
    )
    
    # Clean up temporary files
    os.remove(input_file)
    os.remove(output_file)